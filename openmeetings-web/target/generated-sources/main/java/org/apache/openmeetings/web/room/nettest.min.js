var NetTest=function(){function h(a){isNaN(a.attempts)&&(a.attempts=0);isNaN(a.step)&&(a.step=a.measures,a.astep=a.attempts);Array.isArray(a.results)||(a.results=[],a.lresults=[]);0>a.step||(0===a.step?0<--a.astep?(a.step=a.measures,a.results.push(a.lresults),a.lresults=[],h(a)):(0<a.attempts?a.results.push(a.lresults):a.results=a.lresults,a.onend(a.results)):a.action(a.params,function(c){if(c.ok){var g=c.time;if(a.params.size){var g=a.params.curSize,k=$("\x3cspan\x3e\x3c/span\x3e");"upload"===e?
k.append(b["upl.bytes"]):"download"===e&&k.append(b["dwn.bytes"]);k.append(d(g/1048576,b.mb));k.append("...");f(t(k));g=1E3*a.params.curSize/c.time}a.lresults.push(g)}a.maxTime&&c.time>a.maxTime?a.step=0:a.step--;h(a)}))}function m(a,c){var b="";a.size&&(a.curSize=a.multiplier*(a.curSize?a.curSize:a.size),b="\x26size\x3d"+a.curSize);setTimeout(function(){var d={cache:"no-cache"};if("upload"===a.mode){d.method="POST";var g=Uint8Array.from({length:a.curSize},function(){return Math.floor(255*Math.random())});
d.body=new Blob([g.buffer],{type:"application/octet-stream"})}var f=Date.now();fetch("./services/networktest/"+a.url+b,d).then(function(a){return a.ok?a.arrayBuffer():Promise.resolve(null)}).then(function(a){c({ok:!!a,time:Date.now()-f})}).catch(function(a){OmUtil.log(a);c({ok:!1,time:-1})})},a.delay||0)}function A(){u={ping:{start:function(){n();h({action:m,params:{url:"?type\x3dping"},measures:10,onend:B})}},jitter:{start:function(){n();h({action:m,params:{url:"?type\x3djitter"},measures:5,attempts:3,
onend:C})}},upload:{start:function(){n();h({action:m,params:{url:"?type\x3dupload",mode:"upload",size:524288,multiplier:2,delay:3E3},maxTime:2E3,measures:5,onend:v})}},download:{start:function(){n();h({action:m,params:{url:"?type\x3ddownload",size:2097152,multiplier:2,delay:3E3},maxTime:2E3,measures:5,onend:v})}}}}function n(){var a=$("\x3cspan\x3e\x3c/span\x3e").append(b["report.start"]);f(t(a),!0)}function C(a){var c=$("\x3cspan\x3e\x3c/span\x3e").append("[");a=a.map(function(a){return p(a)});var g=
p(a),k="",e=0,h=Number.MAX_VALUE;a.forEach(function(a){e=Math.max(e,a);h=Math.min(h,a);c.append(k).append(d(a,b.ms));k=","});c.append("]");f(c);f($("\x3cspan\x3e\x3c/span\x3e").append(b["jitter.avg"]).append(d(g,b.ms)));f($("\x3cspan\x3e\x3c/span\x3e").append(b["jitter.min"]).append(d(h,b.ms)));f($("\x3cspan\x3e\x3c/span\x3e").append(b["jitter.max"]).append(d(e,b.ms)));f($("\x3cspan\x3e\x3c/span\x3e").append(b.jitter).append(":").append(d(e-g,b.ms)).append(";").append(d(h-g,b.ms)));q($("\x3cdiv\x3e\x3c/div\x3e").append($('\x3cdiv class\x3d"line"\x3e\x3c/div\x3e').append(b["jitter.avgAbbr"]+
"\x26nbsp;").append(d(g,b.ms))).append($('\x3cdiv class\x3d"line"\x3e\x3c/div\x3e').append(b.jitter+"\x26nbsp;").append(d(e-g,b.ms))))}function B(a){var c=p(a);f($("\x3cspan\x3e\x3c/span\x3e").append(b["ping.avg"]).append(d(c,b.ms)));f($("\x3cspan\x3e\x3c/span\x3e").append(b["ping.rcv"]).append(d(a.length,"")));f($("\x3cspan\x3e\x3c/span\x3e").append(b["ping.lost"]).append(d(10-a.length,"")));q(d(c,b.ms))}function w(){return $("#test-"+e+" button.test-btn")}function q(a){var c=w();c.addClass("complete").removeClass("started");
c.parent().find(".value").html(a);r=c.data("next");r?x&&(e=r,w().click()):x=!1}function v(a){a=p(a);a=d(a/1048576,b.mb+"/"+b.sec);var c=$("\x3cspan\x3e\x3c/span\x3e").append(b["upload"===e?"upl.speed":"dwn.speed"]).append(a);f(c);q(a.clone())}function t(a){return $('\x3cspan class\x3d"delim"\x3e\x3c/span\x3e').html(a)}function f(a,c){l.append("\x3cbr/\x3e");c&&l.append("\x3cbr/\x3e");l.append($('\x3cspan class\x3d"module"\x3e\x3c/span\x3e').text(y)).append(a);l.find("span").last()[0].scrollIntoView(!1)}
function d(a,c){return $('\x3cspan class\x3d"value"\x3e\x3c/span\x3e').append(null==a?"null":a.toFixed(1)+" "+c)}var z={},l,b,u,e,y,r,x=!0,p=function(a){return a.reduce(function(a,b){return a+b})/a.length};z.init=function(a){b=a;l=$(".nettest output");$(".nettest button").click(function(){var a=$(this);a.removeClass("complete").removeClass("not-started").addClass("started");y=a.data("lbl");e=a.data("measure");u[e].start();a.parent().find(".value").html("")});A();$('.nettest button[data-start\x3d"true"]').click()};
return z}();